<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TF CRUD 1.1 - HTML + JS</title>
</head>
<body>
    <form>
        <div id="all_inputs_container">
            <h1>Dados</h1>
            <input class="input_btn" type="button" value="SET RNG" onclick="set_rng()">
            <input class="input_btn" type="button" value="UNSET" onclick="unset_fields()"><br><br>
            <div class="input_container" id="name_container">
                <span>Nome: </span>
                <input type="text" class="input_field" name="name_input" id="name_input" placeholder="Digite seu nome" maxlength="30">
            </div><br>
            <div class="input_container" id="tel_container">
                <span>Telefone: </span>
                <input type="text" class="input_field" name="tel_input" id="tel_input" placeholder="Digite seu telefone" maxlength="12">
            </div><br>
            <div class="input_container" id="birth_container">
                <span>Nascimento: </span>
                <input type="date" class="input_field" name="birth_input" id="birth_input">
            </div><br>
            <div class="input_container" id="grade_container">
                <span>Nota: </span>
                <input type="text" class="input_field" name="grade_input" id="grade_input" maxlength="3">
            </div><br>
            <div id="btn_cotainer">
                <input class="input_btn" type="button" value="Cadastrar" onclick="signUp()">
                <input class="input_btn" type="button" value="Remover" onclick="remove()">
                <input class="input_btn" type="button" onclick="reg_clear()" value="Limpar registro">
                <span id="out_msg"></span>
            </div>

        </div>
        <div id="all_outputs_container">
            <h1>Cadastros</h1>
            <div id="list_container">

            </div>
        </div>
    </form>
<!--========================================== Inicio dos Scripts ==========================================-->
    <script>
        const output = document.getElementById("list_container");
        const out_msg = document.getElementById("out_msg");
        const registry = [];
        const inputs = document.getElementsByClassName("input_field");

        function signUp() {
            let inputted_name = document.getElementById("name_input");
            let inputted_tel = document.getElementById("tel_input");
            let inputted_birth = document.getElementById("birth_input");
            let inputted_grade = document.getElementById("grade_input");

            if (validate(inputted_name.value, inputted_tel.value, inputted_birth.value, inputted_grade.value)){
                var user = {
                    name: inputted_name.value,
                    tel: inputted_tel.value,
                    birth: inputted_birth.value,
                    grade: inputted_grade.value,
                    reg_date: reg_date(),
                    reg_edit: reg_date()
                };
                registry.push(user);
                out_msg.innerHTML = `${user.name} - Cadastrado(a) com sucesso!`;
                show(user);
                inputted_name.focus();
                unset_fields();
            };
        };

        function validate(nome, phone, birth, grade){
            let regNum = /^[\d ,.-]+$/;
            let regTxt = /^[\D ]+$/;
            if (nome.length == 0 || phone.length == 0 || birth.length == 0 || grade.length == 0){
                out_msg.innerHTML = `Preencha todos os dados!`;
                return false;
            } else if (!regTxt.test(nome)){
                out_msg.innerHTML = `Nome só pode conter letras!`;
                return false;
            } else if (!/^[\d -]+$/.test(phone) || !regNum.test(birth) || !regNum.test(grade)){
                out_msg.innerHTML = `Telefone, Nascimento ou nota só podem conter números!`;
                return false;
            } else if (new Date(birth) > new Date()){
                out_msg.innerHTML = `Data de nascimento inválida`;
                return false;
            } else {
                out_msg.innerHTML = ``;
                return true;
            };
        };

        function show() {
            if (registry.length == 0){
                output.innerHTML = "";
                out_msg.innerHTML = "";
            } else {
                var array_output = "";
                for (var index in registry) {
                    var id = parseInt(index);
                    const del = `<input class="input_btn" type='button' value='excluir cadastro' onclick='remove(${id})'>`;
                    const edit = `<input class="input_btn" type='button' value='editar nota' onclick='edit(${id})'>`;
                    array_output += `
                                <div class="user_container" id="user_${id}">
                                ID ${id}: <br>
                                Nome: ${registry[index].name}<br>
                                Telefone: ${registry[index].tel}<br>
                                Nascimento: ${registry[index].birth}<br>
                                Nota: ${registry[index].grade}<br>
                                Data de registro: ${registry[index].reg_date}<br>
                                Ultima edição: ${registry[index].reg_edit}<br>
                                ${edit} | ${del}
                                </div>
                                `;
                };
            output.innerHTML = array_output;
            };
        };

        function remove(id) {
            if (registry.length == 0){
                out_msg.innerHTML = `Cadastro de usuários vazio!`;
                return false;
            } else {
                function isSet(test) {
                    if (typeof (test) != typeof (NaN)) {
                        test = prompt("Valor do ID");
                        if (test.length > 0 && parseInt(test) >= 0 && test < registry.length) {
                            id = parseInt(test);
                            return true;
                        } else {
                            alert("ID inválido");
                            return false;
                        }
                    } else {
                        return true;
                    };
                };
                if (isSet(id)) {
                    if (confirm(`Tem certeza que deseja remover ID ${Number(id)} - ${registry[id].name}?`)) {
                        out_msg.innerHTML = "";
                        registry.splice(parseInt(id), 1);
                    };
                };
                out_msg.innerHTML = "";
                show();
            };
        };

        function reg_clear(){
            if(registry.length == 0){
                out_msg.innerHTML = `Cadastro de usuários vazio!`;
                return false;
            } else {
                if(confirm("Tem certeza que deseja limpar registro?")){
                    registry.splice(0,registry.length);
                    alert("Registro deletado");
                    show();
                };
            };
        };

        function edit(id) {
            var grade = prompt("Insira nova nota");
            if (grade == null) {
                return false;
            } else if (grade.length > 3) {
                alert("max 3 digitos");
            } else if (!/^[\d ,.]+$/.test(grade)){
                alert("Apenas números!");
            } else {
                registry[id].grade = grade;
            };
            registry[id].reg_edit = reg_date();
            show();
        };

        function reg_date() {
            var date = new Date();
            var day = getZeros(date.getDate());
            var month = getZeros((date.getMonth()+1));
            var year = date.getFullYear();

            function getZeros(value) {
                var Verified_Value = (value < 10) ? "0" + value : value;
                return Verified_Value;
            };

            fullDate = `${day}/${month}/${year} às ${getZeros(date.getHours())}:${getZeros(date.getMinutes())}:${getZeros(date.getSeconds())}`;
            return fullDate;
        };

        function set_rng(){
            let inputted_name = document.getElementById("name_input");
            let inputted_tel = document.getElementById("tel_input");
            let inputted_birth = document.getElementById("birth_input");
            let inputted_grade = document.getElementById("grade_input");

            function rng_name(){
                let name_list = [
                    ["Miguel", "Arthur","Heitor", "Helena", "Alice", "Theo", "Davi","Laura", "Gabriel", "Gael", "Valentina", "João Miguel"],
                    ["Silva", "Santos", "Oliveira", "Souza", "Rodrigues", "Ferreira", "Alves", "Pereira", "Lima", "Gomes", "Ribeiro", "Martins"]
                ];
                let rng1 = Math.floor(Math.random() * 12);
                let rng2 = Math.floor(Math.random() * 12);
                return `${name_list[0][rng1]} ${name_list[1][rng2]}`;
            };
            function rng_phone(){
                let rng_number = '9 9';
                for (var c = 0; c < 7; c++){
                    rng_number += Math.floor(Math.random() * 9);
                };
                return rng_number;
            };
            function rng_birth(){
                let rng_date = new Date((new Date()) - Math.floor(Math.random()*1639520144665));
                function hasZero(value){
                    result = value < 10 ? "0" + value : value;
                    return result;
                };
                let rng_birth = `${rng_date.getFullYear()}-${hasZero(rng_date.getMonth()+1)}-${hasZero(rng_date.getDate())}`;
                return rng_birth;
            };
            inputted_name.value = rng_name();
            inputted_tel.value = rng_phone();
            inputted_birth.value = rng_birth();
            inputted_grade.value = (1 + Math.random() * (10 - 1)).toFixed(1);
        };

        function unset_fields(){
            for(var item of inputs){
                item.value = "";
            };
        };

    </script>
</body>
</html>
